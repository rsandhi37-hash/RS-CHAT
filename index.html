<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RS Chat Secure</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Courier New', monospace; 
            background: #0d1117; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
            color: #c9d1d9; 
        }
        
        /* Install Prompt */
        #installPrompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0d1117;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .install-card {
            background: #161b22;
            border: 2px solid #58a6ff;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            text-align: center;
        }
        
        .install-icon { font-size: 80px; margin-bottom: 20px; }
        .install-title { color: #58a6ff; font-size: 28px; margin-bottom: 15px; font-weight: bold; }
        .install-text { color: #8b949e; margin-bottom: 30px; line-height: 1.6; }
        .install-button { 
            background: #238636; 
            color: white; 
            border: none; 
            padding: 18px 40px; 
            border-radius: 50px; 
            font-size: 20px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
        }
        
        /* PIN Screen */
        #pinScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0d1117;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9000;
            backdrop-filter: blur(10px);
        }
        
        .pin-container {
            background: #161b22;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 350px;
            border: 1px solid #30363d;
        }
        
        .pin-title {
            color: #58a6ff;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .pin-display {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            letter-spacing: 8px;
            margin-bottom: 20px;
            color: #58a6ff;
            font-family: monospace;
        }
        
        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .pin-key {
            background: #21262d;
            border: none;
            color: white;
            padding: 20px;
            font-size: 24px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .pin-key:active {
            background: #30363d;
        }
        
        .pin-key.delete {
            background: #da3633;
        }
        
        .pin-key.enter {
            background: #238636;
        }
        
        .pin-error {
            color: #f85149;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        /* Main App */
        #mainApp {
            display: none;
            height: 100vh;
            flex-direction: column;
        }
        
        .header { 
            background: #161b22; 
            color: #58a6ff; 
            padding: 20px; 
            text-align: center; 
            font-weight: bold; 
            border-bottom: 1px solid #30363d; 
        }
        
        #display { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px 15px 150px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        .bubble { 
            max-width: 85%; 
            padding: 12px; 
            border-radius: 10px; 
            font-size: 14px; 
            word-wrap: break-word; 
        }
        
        .sent { background: #238636; color: white; align-self: flex-end; }
        .received { background: #30363d; color: #58a6ff; align-self: flex-start; }
        .system { background: #1f2a40; color: #ffa657; align-self: center; font-style: italic; }
        
        .controls { 
            background: #161b22; 
            padding: 15px; 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            border-top: 1px solid #30363d; 
        }
        
        input { 
            width: 100%; 
            padding: 14px; 
            background: #0d1117; 
            border: 1px solid #30363d; 
            border-radius: 8px; 
            color: #58a6ff; 
            margin-bottom: 12px; 
            outline: none; 
            font-size: 16px; 
        }
        
        .btn-group { display: flex; gap: 10px; }
        
        button { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            border-radius: 8px; 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 15px; 
        }
        
        .dec-btn { background: #1f6feb; }
        .enc-btn { background: #238636; }
        .lock-btn {
            background: #6e40c9;
            margin-top: 10px;
        }
        
        .security-bar {
            background: #0d1117;
            padding: 5px 10px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #30363d;
        }
    </style>
</head>
<body>
    <!-- Install Prompt -->
    <div id="installPrompt">
        <div class="install-card">
            <div class="install-icon">üì±</div>
            <div class="install-title">RS CHAT</div>
            <div class="install-text">
                Ye app sirf installed version mein chalta hai<br>
                Add to Home Screen se install karein
            </div>
            <button class="install-button" id="installButton">
                üì≤ INSTALL APP
            </button>
        </div>
    </div>

    <!-- PIN Screen -->
    <div id="pinScreen">
        <div class="pin-container">
            <div class="pin-title">üîê ENTER PIN</div>
            <div class="pin-display" id="pinDisplay"></div>
            
            <div class="pin-keypad">
                <button class="pin-key" onclick="addPin(1)">1</button>
                <button class="pin-key" onclick="addPin(2)">2</button>
                <button class="pin-key" onclick="addPin(3)">3</button>
                <button class="pin-key" onclick="addPin(4)">4</button>
                <button class="pin-key" onclick="addPin(5)">5</button>
                <button class="pin-key" onclick="addPin(6)">6</button>
                <button class="pin-key" onclick="addPin(7)">7</button>
                <button class="pin-key" onclick="addPin(8)">8</button>
                <button class="pin-key" onclick="addPin(9)">9</button>
                <button class="pin-key delete" onclick="deletePin()">‚å´</button>
                <button class="pin-key" onclick="addPin(0)">0</button>
                <button class="pin-key enter" onclick="verifyPin()">‚úì</button>
            </div>
            
            <div class="pin-error" id="pinError">Wrong PIN! Attempts left: 3</div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <div class="header">
            RS CHAT // üîí LOCKED
        </div>
        
        <div id="display"></div>
        
        <div class="security-bar">
            <span id="lockStatus">üîí App Locked</span>
            <span id="pinStatus">PIN Required</span>
        </div>

        <div class="controls">
            <input type="text" id="userInput" placeholder="App locked - Enter PIN first" disabled>
            <div class="btn-group">
                <button class="dec-btn" onclick="handleDecrypt()" id="decryptBtn" disabled>üîì DECODE</button>
                <button class="enc-btn" onclick="handleEncrypt()" id="encryptBtn" disabled>üîí SEND</button>
            </div>
            <button class="lock-btn" onclick="showPinScreen()" id="unlockBtn">üîì UNLOCK APP</button>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const APP_PIN = "1818"; // Change this to your PIN
        const MASTER_KEY = "REHAN_SANDHI_181_SECURE";
        let isUnlocked = false;
        let pinAttempts = 0;
        let currentPin = "";
        
        // ==================== INSTALLATION CHECK ====================
        let deferredPrompt;
        const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
        
        window.addEventListener('load', () => {
            if (isInstalled) {
                // Installed mode - Show PIN screen
                document.getElementById('installPrompt').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                showPinScreen();
            } else {
                // Browser mode - Show install prompt
                document.getElementById('installPrompt').style.display = 'flex';
            }
        });
        
        // Handle install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            document.getElementById('installButton').addEventListener('click', async () => {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('App installed');
                }
                deferredPrompt = null;
            });
        });
        
        // ==================== PIN AUTHENTICATION ====================
        function showPinScreen() {
            document.getElementById('pinScreen').style.display = 'flex';
            currentPin = "";
            updatePinDisplay();
        }
        
        function hidePinScreen() {
            document.getElementById('pinScreen').style.display = 'none';
        }
        
        function addPin(num) {
            if (currentPin.length < 4) {
                currentPin += num;
                updatePinDisplay();
            }
            
            // Auto-verify when 4 digits entered
            if (currentPin.length === 4) {
                setTimeout(() => verifyPin(), 200);
            }
        }
        
        function deletePin() {
            currentPin = currentPin.slice(0, -1);
            updatePinDisplay();
        }
        
        function updatePinDisplay() {
            let display = "";
            for (let i = 0; i < 4; i++) {
                if (i < currentPin.length) {
                    display += "‚óè";
                } else {
                    display += "‚óã";
                }
            }
            document.getElementById('pinDisplay').textContent = display;
        }
        
        function verifyPin() {
            if (currentPin === APP_PIN) {
                // Correct PIN
                isUnlocked = true;
                pinAttempts = 0;
                hidePinScreen();
                
                // Enable app
                document.getElementById('userInput').disabled = false;
                document.getElementById('decryptBtn').disabled = false;
                document.getElementById('encryptBtn').disabled = false;
                document.getElementById('unlockBtn').textContent = "üîí LOCK APP";
                document.getElementById('lockStatus').innerHTML = "üîì App Unlocked";
                document.getElementById('pinStatus').innerHTML = "‚úì PIN Verified";
                document.querySelector('.header').innerHTML = "RS CHAT // üîì UNLOCKED";
                
                // Welcome message
                addBubble('üîê App Unlocked Successfully!', 'system');
                addBubble('üí¨ Type message and click SEND to encrypt', 'system');
            } else {
                // Wrong PIN
                pinAttempts++;
                const attemptsLeft = 3 - pinAttempts;
                
                if (attemptsLeft <= 0) {
                    // Lock app completely
                    document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: #f85149;"><h1>üîí APP LOCKED</h1><p>Too many failed attempts</p></div>';
                } else {
                    document.getElementById('pinError').style.display = 'block';
                    document.getElementById('pinError').textContent = `Wrong PIN! Attempts left: ${attemptsLeft}`;
                    currentPin = "";
                    updatePinDisplay();
                }
            }
        }
        
        function lockApp() {
            isUnlocked = false;
            document.getElementById('userInput').disabled = true;
            document.getElementById('decryptBtn').disabled = true;
            document.getElementById('encryptBtn').disabled = true;
            document.getElementById('unlockBtn').textContent = "üîì UNLOCK APP";
            document.getElementById('lockStatus').innerHTML = "üîí App Locked";
            document.getElementById('pinStatus').innerHTML = "PIN Required";
            document.querySelector('.header').innerHTML = "RS CHAT // üîí LOCKED";
            addBubble('üîí App Locked - Enter PIN to continue', 'system');
        }
        
        // ==================== ENCRYPTION ====================
        async function handleEncrypt() {
            if (!isUnlocked) {
                showPinScreen();
                return;
            }
            
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            
            if (!text) {
                addBubble('‚ö†Ô∏è Type a message', 'system');
                return;
            }
            
            try {
                // Simple but strong encryption
                const encrypted = btoa(text + "|" + Date.now() + "|" + MASTER_KEY.substring(0, 5));
                addBubble(text, 'sent');
                await navigator.clipboard.writeText(encrypted);
                addBubble('üìã Encrypted! Copied to clipboard', 'system');
                window.open(`https://wa.me/?text=${encodeURIComponent(encrypted)}`, '_blank');
            } catch (error) {
                addBubble('‚ùå Encryption failed', 'system');
            }
            
            input.value = '';
        }
        
        async function handleDecrypt() {
            if (!isUnlocked) {
                showPinScreen();
                return;
            }
            
            const input = document.getElementById('userInput');
            const encryptedText = input.value.trim();
            
            if (!encryptedText) {
                addBubble('‚ö†Ô∏è Paste encrypted code', 'system');
                return;
            }
            
            try {
                const decoded = atob(encryptedText);
                const parts = decoded.split('|');
                
                if (parts.length >= 1) {
                    addBubble('üîì Decoded: ' + parts[0], 'received');
                } else {
                    addBubble('‚ùå Invalid message', 'system');
                }
            } catch (error) {
                addBubble('‚ùå Decryption failed - Invalid format', 'system');
            }
            
            input.value = '';
        }
        
        function addBubble(text, type) {
            const display = document.getElementById('display');
            const div = document.createElement('div');
            div.className = `bubble ${type}`;
            div.innerText = text;
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
        }
        
        // ==================== SECURITY FEATURES ====================
        
        // Auto-lock on app switch
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isUnlocked) {
                setTimeout(() => {
                    if (document.hidden) {
                        lockApp();
                    }
                }, 1000);
            }
        });
        
        // Auto-lock after 5 minutes
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (isUnlocked) {
                inactivityTimer = setTimeout(() => {
                    lockApp();
                    addBubble('‚è±Ô∏è Auto-locked due to inactivity', 'system');
                }, 300000); // 5 minutes
            }
        }
        
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        
        // Toggle lock button
        document.getElementById('unlockBtn').addEventListener('click', function() {
            if (isUnlocked) {
                lockApp();
            } else {
                showPinScreen();
            }
        });
    </script>
</body>
</html>            background: #238636; 
            color: white; 
            align-self: flex-end; 
        }
        
        .received { 
            background: #30363d; 
            color: #58a6ff; 
            align-self: flex-start; 
        }
        
        .system { 
            background: #1f2a40; 
            color: #ffa657; 
            align-self: center; 
            font-style: italic; 
            border: 1px dashed #58a6ff; 
        }
        
        .encrypted-bubble {
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            opacity: 0.8;
        }
        
        .controls { 
            background: #161b22; 
            padding: 15px; 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            border-top: 1px solid #30363d; 
            z-index: 100; 
        }
        
        input { 
            width: 100%; 
            padding: 14px; 
            background: #0d1117; 
            border: 1px solid #30363d; 
            border-radius: 8px; 
            color: #58a6ff; 
            margin-bottom: 12px; 
            outline: none; 
            font-size: 16px; 
        }
        
        .btn-group { 
            display: flex; 
            gap: 10px; 
        }
        
        button { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            border-radius: 8px; 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 15px; 
            transition: all 0.3s; 
        }
        
        button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        
        .dec-btn { 
            background: #1f6feb; 
        }
        
        .enc-btn { 
            background: #238636; 
        }
        
        .fingerprint-btn {
            background: #6e40c9;
            padding: 10px;
            margin-top: 5px;
            font-size: 12px;
        }
        
        .security-status {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            background: #0d1117;
            border-top: 1px solid #30363d;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <!-- Install Prompt (Browser Mode) -->
    <div id="installPrompt">
        <div class="install-card">
            <div class="install-icon">üì±</div>
            <div class="install-title">RS CHAT</div>
            <div class="install-text">
                Ye app sirf installed version mein chalta hai<br><br>
                <strong>Security Features:</strong><br>
                ‚úì End-to-End Encryption<br>
                ‚úì Biometric Authentication<br>
                ‚úì Auto Session Destroy<br>
                ‚úì Screen Capture Protection<br>
                ‚úì Offline Support
            </div>
            <button class="install-button" id="installButton">
                üì≤ INSTALL APP
            </button>
            <div class="install-note">
                Add to home screen se app install karein
            </div>
        </div>
    </div>

    <!-- Main App (Installed Mode) -->
    <div id="mainApp">
        <div class="header">
            RS CHAT // SECURE TERMINAL
            <span class="security-badge" id="securityLevel">üîí MAX</span>
        </div>
        
        <div id="display"></div>
        
        <div class="security-status">
            <span id="authStatus">üîê Biometric: Required</span>
            <span id="sessionTimer">‚è±Ô∏è Session: 15:00</span>
            <span id="encryptionStatus">üîë AES-256</span>
        </div>

        <div class="controls">
            <input type="text" id="userInput" placeholder="Type message..." autocomplete="off">
            <div class="btn-group">
                <button class="dec-btn" onclick="handleDecrypt()" id="decryptBtn">üîì DECODE</button>
                <button class="enc-btn" onclick="handleEncrypt()" id="encryptBtn">üîí SEND</button>
            </div>
            <button class="fingerprint-btn" onclick="authenticateUser()" id="authBtn">
                üñêÔ∏è Verify Fingerprint / Face
            </button>
        </div>
    </div>

    <script>
        // ==================== SECURITY CONFIG ====================
        const SECURITY_CONFIG = {
            MASTER_PASSWORD: "REHAN_SANDHI_181_" + Math.random().toString(36),
            SESSION_TIMEOUT: 900000, // 15 minutes
            MAX_ATTEMPTS: 3,
            BIOMETRIC_REQUIRED: true
        };
        
        // ==================== INSTALLATION CHECK ====================
        let deferredPrompt;
        const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
        
        window.addEventListener('load', () => {
            if (isInstalled) {
                // Installed mode - Show app
                document.getElementById('installPrompt').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                initializeSecureApp();
            } else {
                // Browser mode - Show install prompt
                document.getElementById('installPrompt').style.display = 'flex';
            }
        });
        
        // Handle install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            document.getElementById('installButton').addEventListener('click', async () => {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
            });
        });
        
        // ==================== BIOMETRIC AUTH ====================
        let isAuthenticated = false;
        let authAttempts = 0;
        
        async function authenticateUser() {
            if (!SECURITY_CONFIG.BIOMETRIC_REQUIRED) return true;
            
            try {
                // Check if biometric is available
                if (window.PublicKeyCredential) {
                    const authBtn = document.getElementById('authBtn');
                    authBtn.disabled = true;
                    authBtn.innerText = '‚è≥ Verifying...';
                    
                    // Request biometric authentication
                    const credential = await navigator.credentials.get({
                        publicKey: {
                            challenge: new Uint8Array(32),
                            rpId: window.location.hostname || 'localhost',
                            userVerification: 'required',
                            timeout: 60000
                        }
                    });
                    
                    if (credential) {
                        isAuthenticated = true;
                        authAttempts = 0;
                        document.getElementById('authStatus').innerHTML = 'üîì Biometric: Verified';
                        document.getElementById('authBtn').innerText = '‚úÖ Verified';
                        startSessionTimer();
                        return true;
                    }
                } else {
                    // Fallback to PIN if biometric not available
                    return fallbackAuth();
                }
            } catch (error) {
                authAttempts++;
                if (authAttempts >= SECURITY_CONFIG.MAX_ATTEMPTS) {
                    lockApp();
                }
                document.getElementById('authStatus').innerHTML = '‚ùå Verification Failed';
                document.getElementById('authBtn').innerText = 'üñêÔ∏è Try Again';
            }
            authBtn.disabled = false;
            return false;
        }
        
        function fallbackAuth() {
            const pin = prompt('Enter Security PIN (default: 1234):');
            if (pin === '1234') { // Change this in production
                isAuthenticated = true;
                document.getElementById('authStatus').innerHTML = 'üîì PIN Verified';
                return true;
            }
            return false;
        }
        
        function lockApp() {
            document.getElementById('display').innerHTML = '';
            addBubble('üîí TOO MANY ATTEMPTS - APP LOCKED', 'system');
            document.getElementById('userInput').disabled = true;
            document.getElementById('encryptBtn').disabled = true;
            document.getElementById('decryptBtn').disabled = true;
        }
        
        // ==================== SESSION MANAGEMENT ====================
        let sessionInterval;
        
        function startSessionTimer() {
            let timeLeft = SECURITY_CONFIG.SESSION_TIMEOUT / 1000;
            
            sessionInterval = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('sessionTimer').innerHTML = 
                    `‚è±Ô∏è Session: ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(sessionInterval);
                    destroySession();
                }
            }, 1000);
        }
        
        function destroySession() {
            isAuthenticated = false;
            document.getElementById('display').innerHTML = '';
            document.getElementById('userInput').disabled = true;
            document.getElementById('encryptBtn').disabled = true;
            document.getElementById('decryptBtn').disabled = true;
            addBubble('üîí SESSION EXPIRED - Re-authenticate', 'system');
            document.getElementById('authBtn').style.display = 'block';
        }
        
        // ==================== ENCRYPTION (AES-256-GCM) ====================
        async function getEncryptionKey() {
            const encoder = new TextEncoder();
            const passwordData = encoder.encode(SECURITY_CONFIG.MASTER_PASSWORD);
            
            const keyMaterial = await crypto.subtle.importKey(
                'raw', passwordData, { name: 'PBKDF2' }, false, ['deriveKey']
            );
            
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: encoder.encode('RS-CHAT-SECURE-SALT-2026'),
                    iterations: 600000, // High iterations for security
                    hash: 'SHA-512'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }
        
        async function secureEncrypt(text) {
            if (!isAuthenticated) {
                addBubble('üîí Please verify first', 'system');
                return null;
            }
            
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const key = await getEncryptionKey();
                
                const encryptedData = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv, additionalData: encoder.encode('RS-CHAT') },
                    key,
                    data
                );
                
                const combined = new Uint8Array(iv.length + encryptedData.byteLength);
                combined.set(iv, 0);
                combined.set(new Uint8Array(encryptedData), iv.length);
                
                return btoa(String.fromCharCode(...combined));
            } catch (error) {
                console.error('Encryption error:', error);
                return null;
            }
        }
        
        async function secureDecrypt(encryptedText) {
            if (!isAuthenticated) {
                addBubble('üîí Please verify first', 'system');
                return null;
            }
            
            try {
                const combined = new Uint8Array(
                    atob(encryptedText).split('').map(c => c.charCodeAt(0))
                );
                
                const iv = combined.slice(0, 12);
                const data = combined.slice(12);
                const key = await getEncryptionKey();
                const encoder = new TextEncoder();
                
                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv, additionalData: encoder.encode('RS-CHAT') },
                    key,
                    data
                );
                
                return new TextDecoder().decode(decryptedData);
            } catch (error) {
                console.error('Decryption error:', error);
                return null;
            }
        }
        
        // ==================== UI FUNCTIONS ====================
        async function handleEncrypt() {
            if (!isAuthenticated) {
                addBubble('üîí Please verify fingerprint first', 'system');
                return;
            }
            
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            
            if (!text) {
                addBubble('‚ö†Ô∏è Type a message', 'system');
                return;
            }
            
            setButtonsState(true);
            
            try {
                addBubble(text, 'sent');
                const encrypted = await secureEncrypt(text);
                
                if (encrypted) {
                    await navigator.clipboard.writeText(encrypted);
                    addBubble('üìã Encrypted! Copied to clipboard', 'system');
                    addBubble('üîê ' + encrypted.substring(0, 50) + '...', 'encrypted-bubble received');
                    window.open(`https://wa.me/?text=${encodeURIComponent(encrypted)}`, '_blank');
                }
            } catch (error) {
                addBubble('‚ùå Encryption failed', 'system');
            }
            
            input.value = '';
            setButtonsState(false);
        }
        
        async function handleDecrypt() {
            if (!isAuthenticated) {
                addBubble('üîí Please verify fingerprint first', 'system');
                return;
            }
            
            const input = document.getElementById('userInput');
            const encryptedText = input.value.trim();
            
            if (!encryptedText) {
                addBubble('‚ö†Ô∏è Paste encrypted code', 'system');
                return;
            }
            
            setButtonsState(true);
            
            try {
                const decrypted = await secureDecrypt(encryptedText);
                
                if (decrypted) {
                    addBubble('üîì Decoded: ' + decrypted, 'received');
                } else {
                    addBubble('‚ùå Invalid or tampered message', 'system');
                }
            } catch (error) {
                addBubble('‚ùå Decryption failed', 'system');
            }
            
            input.value = '';
            setButtonsState(false);
        }
        
        function addBubble(text, type) {
            const display = document.getElementById('display');
            const div = document.createElement('div');
            div.className = `bubble ${type}`;
            div.innerText = text;
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
        }
        
        function setButtonsState(disabled) {
            document.getElementById('encryptBtn').disabled = disabled;
            document.getElementById('decryptBtn').disabled = disabled;
        }
        
        // ==================== SCREEN PROTECTION ====================
        function initializeSecureApp() {
            // Prevent screenshots (basic)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    document.body.style.filter = 'blur(10px)';
                } else {
                    document.body.style.filter = 'none';
                }
            });
            
            // Prevent copy-paste from other apps
            document.addEventListener('copy', (e) => {
                e.clipboardData.setData('text/plain', 'üîí Protected Content');
                e.preventDefault();
            });
            
            // Auto lock on app switch
            window.addEventListener('blur', () => {
                if (isAuthenticated) {
                    setTimeout(() => {
                        if (!document.hasFocus()) {
                            isAuthenticated = false;
                            document.getElementById('authStatus').innerHTML = 'üîê Re-authentication Required';
                        }
                    }, 1000);
                }
            });
            
            // Welcome message
            addBubble('üîí MAX SECURITY MODE ACTIVE', 'system');
            addBubble('‚ö° Biometric required for each session', 'system');
            addBubble('üì± This app works only in installed mode', 'system');
            
            // Auto-request authentication
            setTimeout(() => authenticateUser(), 500);
        }
    </script>
</body>
</html>                throw new Error();
            }
        } catch (e) {
            addBubble("Error: Invalid Code or Expired!", "received");
        }
        document.getElementById('userInput').value = "";
    }

    function addBubble(text, type) {
        const win = document.getElementById('display');
        const div = document.createElement('div');
        div.className = `bubble ${type}`;
        div.innerText = text;
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }
</script>

</body>
</html>
